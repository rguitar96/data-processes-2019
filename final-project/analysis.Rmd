---
output:
  html_document
---
```{r}
library(dplyr)
library(ggplot2)
library(patchwork)
library(treemapify)
library(reshape2)
library(plyr)
library(tidyverse)
library(plotly)
library(maps)
```


```{r}
usa_deaths_states = read.csv("data/death-causes-usa.csv", sep=";") %>% filter(Cause.Name != "All causes")
spain_deaths = read.csv("data/death-causes-spain-2017-modified.csv", sep=";",fileEncoding="UTF-8-BOM")
```

USA data set


The data published by the Centers for Disease Control and Prevention was gathered by the National Center for Health Statistics (NCHS), with the last revision being made in 2017. This data set contains the information of the 10 leading causes of death in the United States. The data is based on information from resident death certificates filed in the 50 states and the District of Columbia using demographic and medical characteristics. The data set holds 10868 observations, each with the following 6 features:

  * **Year**: The year the sample was taken
  * **X113.Cause.Name**: Official labeled causes of death
  * **Cause.Name**: Simplified cause of death name
  * **State**: Name of the state the sample was taken. Inclues "United States" which is the total accross the entire country
  * **Deaths**: The number of deaths due to the cause in the state in the given year
  * **Age-adjusted-death-rate**: The death rate adjusted for the age range in the state the sample is from. The rates are per 100,000                                  population and based on the 2000 U.S. standard population.



```{r}
dim(usa_deaths_states)
head(usa_deaths_states)
```

Spanish data set


The second data set details the causes of death in Spain for the year 2017. It was found on the  government website, https://datos.gob.es/, although since the original project proposal is no longer available at the found location. This data was collected as  part of a study done by the Spanish Institute of Statistics (INE). Due to the layout of the data it was required to transform it so it could be processed. During this process the list of disease types were reduced by combining multiple of the same type to one so it was compared to the USA data set. An example of this is the Spanish data set has 30 types of cancer listed, while the USA set has 1, so the totals for the Spanish set were totaled under the name “Cancer”. The resulting data consists of 1056 observations with the following 4 features:

	* **DISEASE**: Name of cause of death
	* **GENDER**: The genender of the people represented by the observation, includes Males, Females and Both (total of both males and                 females)
	* **AGE**: The age range of the people who died in the observation
	* **NUMBER.OF.DEATHS**: The number of people that died



```{r}
dim(spain_deaths)
head(spain_deaths)
```


As we see, we have different data for both countries, so the comparison will be tough. We will first filter for the country data, filtering state data in the US data set in order to view the country as a whole.

```{r}
usa_deaths = usa_deaths_states %>% filter(State == "United States")
head(usa_deaths)
```


```{r}
area_plot <- ggplot(usa_deaths, aes(x=Year, y=Age.adjusted.Death.Rate, fill=Cause.Name)) + 
  labs(title = "Trend of death causes", x = "", y = "Death Rate / 100.000 (Age Adjusted)", fill = "Causes") +
  scale_color_brewer(palette = "Paired") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  geom_area()

line_plot <- ggplot(usa_deaths, aes(x=Year, y=log(Deaths), color=Cause.Name)) + 
  labs(title = "Changes on death causes over the years", x = "", y = "log(Death Rate)", fill = "Causes") +
  scale_color_brewer(palette = "Paired") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  geom_line() 

ggplotly(area_plot)
ggplotly(line_plot)
```


```{r}

#Get data about the top 10 diseases in the Spanish data set. Ignore "Other causes"
topTenSpanishDiseases<- spain_deaths %>% filter(GENDER == "Both") %>% filter(AGE=="All ages") %>% filter(DISEASE!="All causes") %>% filter(DISEASE!="Other causes") %>% top_n(10, NUMBER.OF.DEATHS)

#Generate tree map
ggplot(topTenSpanishDiseases, aes(area=NUMBER.OF.DEATHS, fill=DISEASE, label=NUMBER.OF.DEATHS)) +
  scale_fill_brewer(palette = "Paired") +
  labs(title = "Most deadly diseases in Spain (2017)", fill = "Causes") +
  geom_treemap() +
  geom_treemap_text(fontface = "italic",
                    colour = "white",
                    place = "centre",
                    grow = FALSE,
                    reflow = TRUE) 

```


```{r}
topTenSpanishDiseasesByGenre <- spain_deaths %>% filter(GENDER != "Both") %>% filter(DISEASE != "All causes") %>% filter(AGE == "All ages")      %>%  filter(DISEASE %in% topTenSpanishDiseases$DISEASE)

topTenSpanishDiseasesByGenre$DISEASE  <- with(topTenSpanishDiseasesByGenre, reorder(DISEASE, NUMBER.OF.DEATHS))

barplot <- ggplot(topTenSpanishDiseasesByGenre, aes(fill=DISEASE, y=NUMBER.OF.DEATHS, x=GENDER)) + 
  scale_fill_brewer(palette = "Paired") +
    geom_bar(position=position_stack(), stat="identity", width=0.4) +
  labs(x="", y = "Number of deaths (2017)")+
  theme_minimal()

barplot

#ggplotly(barplot) %>% layout(bargap=0.1) #messes with the legend
```



```{r}

#Create data frame to hold data about people who have Diseases of the circulatory system
diseasesCircSystemData <- spain_deaths

#Set up AGE factor for pyramid plot
diseasesCircSystemData$AGE <- factor(diseasesCircSystemData$AGE, c("0 to 1", "1 to 4", "5 to 9", "10 to 14", "15 to 19", "20 to 24", "25 to 29", "30 to 34", "35 to 39", "40 to 44", "45 to 49", "50 to 54", "55 to 59", "60 to 64", "65 to 69", "70 to 74", "75 to 79", "80 to 84", "85 to 89", "90 to 94", "95 or more", "All ages"))

#Filter data to create table about only circular system disease 
diseasesCircSystemData <- diseasesCircSystemData %>% filter(DISEASE == "Diseases of the circulatory system") %>% filter(GENDER != "Both") %>% filter(AGE != "All ages") %>% modify_at("DISEASE",~NULL)

summary(diseasesCircSystemData)
```

```{r}
#Mutate Male data so it will be negative on bargraph
diseasesCircSystemData <- diseasesCircSystemData %>% mutate(NUMBER.OF.DEATHS = ifelse(GENDER == "Males", -1 * NUMBER.OF.DEATHS, NUMBER.OF.DEATHS))

#Generate pyramid plot
ggplot(diseasesCircSystemData, aes(x = AGE, y = NUMBER.OF.DEATHS, fill = GENDER)) + 
  geom_bar(data=diseasesCircSystemData[diseasesCircSystemData$GENDER == "Females",], stat = "identity") + 
  geom_bar(data=diseasesCircSystemData[diseasesCircSystemData$GENDER == "Males",], stat = "identity") + 
  scale_y_continuous(breaks = seq(-15000, 15000, 5000), 
                     labels = paste0(as.character(c(seq(15, 0, -5), seq(5, 15, 5))), "")) +
  coord_flip(ylim=c(-15000,15000)) + 
  scale_fill_brewer(palette = "Set1") + 
  labs(title = "Number of people who die from Diseases of the circulatory system", y = "Number of deaths (1,000)", x = "Age", fill = "Gender") +
  theme_bw()
```


```{r}
unique(usa_deaths_states$State)
```



```{r}
unique(usa_deaths_states$Cause.Name)
```


```{r}
data <- usa_deaths_states
data <- usa_deaths_states %>% filter(Year == 2017) %>% filter(State != "United States")

data <- left_join(data, aggregate(data$Deaths, by=list(State=data$State), FUN=sum), by="State")


data <- data %>% filter(Year == 2017) %>% filter(State != "United States") %>% filter(Cause.Name == "Suicide")





data$region <- tolower(data$State)

states <- map_data("state")
suicide_map <- left_join(states, data, by = "region")

death_map <- ggplot(data = suicide_map) + 
  geom_polygon(aes(x = long, y = lat, fill = Deaths/x, group = group), color = "white") + 
  coord_fixed(1.3) +
  labs(x="", y="") +
  theme_void() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "white")) +
    scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  guides(fill=FALSE)  # do this to leave off the color legend

death_adjusted_map <- ggplot(data = suicide_map) + 
  geom_polygon(aes(x = long, y = lat, fill = Age.adjusted.Death.Rate, group = group), color = "white") + 
  coord_fixed(1.3) +
  labs(x="", y="") +
  theme_void() +
  theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "white")) +
    scale_fill_continuous(high = "#132B43", low = "#56B1F7") +
  guides(fill=FALSE)  # do this to leave off the color legend

ggplotly(death_map)
ggplotly(death_adjusted_map)
```


